# タブ管理とスラッシュ通知のリファクタリング計画

## 背景

タブ管理とスラッシュ通知の寿命処理が `App` に増えています。

`App` の責務が太くなり、テストと読みやすさが落ちています。

## 目的

タブ管理を独立した小さな構造に分けます。

通知の寿命判定をテスト可能にします。

UI 向けの文字列整形を Core から外します。

## いま見えている負担

- `TabsState` が `App` に内包され、表示用文字列を作っています。
- `SlashFeedback` が `Instant::now()` に直接依存しています。
- タブ切り替えとディレクトリ変更の責務が混ざっています。

## 方向性

### 構造変更（Tidy First）

1. `tabs` を独立モジュールに分けます。

`App` は `TabsState` を使うだけにします。

2. タブの一覧は構造化データにします。

`TabSummary { number, path, active }` のような小さな型を返します。

3. フィードバックの現在時刻を注入します。

`AppClock` トレイトで `now()` を渡します。

4. `set_current_dir` と `refresh` の責務を分けます。

`change_dir` はタブ保存と移動だけにします。

### ふるまい変更

表示の文字列は UI で組み立てます。

`/tab` の一覧は UI が `TabSummary` を使って整形します。

期限切れの扱いは今の動作を維持します。

## TDD 最小ステップ

1. `tabs` モジュールの単体テストを追加します。

`push_new` と `switch_to` の動作だけを先に確かめます。

2. `TabSummary` を返す関数のテストを追加します。

表示文字列はまだ作りません。

3. `AppClock` のフェイクを用意します。

`SlashFeedback` の有効判定を時刻注入でテストします。

4. `App` の既存テストを `tabs` の API に合わせて更新します。

緑になったら UI の整形へ移します。

## 実装の順序

1. 構造変更だけを入れます。

2. テストが緑のまま小さく整理します。

3. UI 側に文字列整形を移します。

4. ふるまいを変える前に確認テストを追加します。

## 補足

Core と UI の境界は今の方針を維持します。

メッセージは明示的に渡す前提を崩しません。

## ToDo

- [x] `TabsState` の抽出対象と API を定義する
- [x] `TabSummary` の構造と返却場所を決める
- [ ] `AppClock` のトレイトとテスト用実装を用意する
- [ ] UI 側の文字列整形の移動先を決める
- [ ] 既存テストの更新対象を洗い出す
