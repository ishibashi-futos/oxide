# セッション暗号化

## 概要

セッションファイルはユーザーの開いているディレクトリ情報を含むため、機密性を高めるための暗号化をオプトインで提供する。暗号化を導入しても起動・終了の手順が煩雑にならないよう、パスフレーズの管理とシステム統合（macOS Keychain + Touch ID など）の UX を考慮する。

## 要件

1. セッション保存時に暗号化鍵（パスフレーズ）を使い、AES-GCM 等の対称暗号で `session.json` およびスナップショットファイルを保護する。
2. ファイル内には暗号化バージョン、nonce、タグ、暗号化フラグを含め、復号時に自動的に判別できるようにする。
3. 暗号化を有効化していない場合は平文で保存し、互換性を保つ。
4. CLI 設定または対話的入力でパスフレーズを受け取り、記憶させるためのオプション（Keychain など）を提供する。パスフレーズが未設定・間違っている場合は復元をスキップし、その旨を UI に通知する。
5. 復元失敗時も他のタブには影響を与えず最低限のセッションを開いて作業を続けられる。

## ユーザー体験レベルの受け入れ条件

1. 暗号化を有効化したセッションは、パスフレーズが正しくないと復元できず、明示的なエラーメッセージが表示される。
2. 初回暗号化時のパスフレーズ入力後に、Keychain 等から Touch ID で再利用できる設定を案内し、パスフレーズ入力の頻度を下げる。
3. Touch ID をサポートする環境（macOS + 指紋センサ）では、`LocalAuthentication` 経由で認証を行い、CLI 起動時に Touch ID で鍵のロック解除を試みる。ただし Touch ID が利用できない場合は代替としてパスフレーズ入力を求める。
4. Touch ID の利用には環境依存の制約（初回のみパスワード確認、一定時間後に再認証など）があるため、説明文やログでその限界を案内する。
5. 暗号化を無効化しておけば、従来どおり `session.json` をテキストエディタで確認でき、復元に追加の認証は不要。

## 制約事項

- 暗号化鍵を忘れた場合のリカバリ手段は提供しないため、ユーザーに再設定手順を明示する。
- Touch ID や Keychain 統合は macOS 固有の追加機能であり、他のプラットフォームでは単純なパスフレーズ入力になる。
- セッションファイル自体にファイル内容や環境変数などの機密情報は含めないが、アクセスパスが判別可能なため非暗号化時は露出リスクがある。
- 暗号化を有効化すると CLI 起動前に追加のチェック（Touch ID 認証やパスフレーズ入力）が必要になり、CI やスクリプト運用時は無効化するオプションを明示する。
