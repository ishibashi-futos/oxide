# セッション永続化 (4.2)

## 概要

セッション永続化は、複数タブの作業状態（タブ + パス）を保存し、起動時に再構築することで連続的な作業体験を提供する。選択中のインデックスや UI 状態は含めず、core 層が責務を持ち、TUI は明示的なメッセージで保存／復元を協議する。

## 保存対象

- `SessionSnapshot` は uuid（起動セッション単位）、タブ一覧（`tab_id` + `path`）の最小構成。
- 選択中インデックスやソート、フィルタ等の UI 状態は保存対象外とし、core 層で整合性を保つ。
- `path` は文字列で保持し、存在しない/マウント待ちのパスはエラー状態として扱う。

## 永続化先と構造

- 「現在セッション」は常に `~/.config/oxide/session.json` に置く（Windows でも `%USERPROFILE%/.config/oxide/session.json` を使用し、XDG ベースの構成に統一）。
- 保存は atomic な tmp → rename で行い、中断やクラッシュでの破損を防ぐ。
- `session.json` には現在の snapshot のうち最新の UUID とタブ一覧、暗号化情報（使用中の鍵メタ）を含める。

## スナップショット履歴

- 起動セッションごとに UUID（v4）を生成し、更新／終了時に `~/.config/oxide/sessions/{timestamp}-{uuid}.json` を出力。
- `timestamp` は `YYYYMMDDHHMMSS` 形式とし、テキストソートで時系列に並ぶようにする。
- ローカルストレージには直近 50 までのファイルを保持し、超過後は古いものから削除。
- 書き出し時も atomic 書き込み + rename で整合性を保ち、失敗した場合はログのみ。

## 復元フロー

- 起動時、最初に `session.json` を読み込み snapshot を再構築。失敗した場合は現在の `cwd` をタブに展開。
- 各パスの存在確認を行い、ネットワークドライブの遅延は「接続中…」中間状態＋メッセージで UI に通知する。
- 復元時のエラー（存在しない、権限不足、暗号化エラーなど）は個別タブで処理し、他のタブへの影響を避ける。

## 開発仕様

1. `core::session` モジュールを作成し、`SessionSnapshot`・`SessionStore`・`SessionRestoreResult` 等を定義する。
2. JSON (de)serialization は serde で実装し、`SessionSnapshot` に version フィールドを持たせ将来の拡張を見据える。
3. 保存処理は `SessionStorage` trait を抽象化し、実装はファイルベース。依存注入でテストが可能な構成とする。
4. 暗号化は `SessionEncryptor` trait として分離し、テスト時はモック化。AES-GCM をベースに nonce とタグを記録。
5. UI からは明示的な `SaveSession` / `RestoreSession` メッセージを core に送る。core 側で `SessionStore` を処理し、成功／失敗を UI に通知。
6. タブ構成の変更（追加・削除・パス変更）時に保存トリガーを起動する。ただし頻度を調整するため debounce 処理を入れる。
7. 統合テストではシャットダウン前後で `session.json` が生成され、起動時に同じタブ構成が再現されることを確認。

## 受け入れ条件（ユーザー体験）

1. `Ctrl+Q` や `Ctrl+C` ×2 で終了すると、`~/.config/oxide/session.json` が更新され、起動時に同じタブ（ID + パス）が復元される。
2. タブ構成の変更後すぐに `~/.config/oxide/sessions/{timestamp}-{uuid}.json` に履歴が記録され、50世代目を超えると最古が削除される。
3. 暗号化オプションを有効化した場合、保存ファイルは復号なしでは読めず、設定したパスフレーズで再起動時に正常復元される。
4. 復元失敗（パス消失、暗号化不一致など）のタブはスキップされるが、他のタブは問題なく復元されて作業を再開できる。
5. 復元中に遅延があるパスは UI で「接続中…」等のフィードバックを受け取り、UI 全体が固まらない。

## 制約事項

- セッションファイルに機密情報（ファイル内容や環境変数）は含めない。ただしアクセス先のディレクトリ名は、暗号化なしだと外部に露出する。
- 暗号化の実装は optional で、パスフレーズを忘れた場合のリカバリは提供しない。
- 履歴保存はローカルディスクに限定し、クラウド同期等は含まない。
- `~/.config/oxide` ディレクトリが存在しない場合は自動で作成。アクセス権限がない環境では保存に失敗するためエラー通知を必須とする。
